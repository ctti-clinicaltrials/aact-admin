<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="mb-3">Database Usage Dashboard</h1>
    </div>
    <div class="col-md-4 text-end">
      <div class="btn-group" role="group">
        <%= link_to "Weekly View", admin_dashboard_path(view: 'weekly'), class: "btn #{@view_type == 'weekly' ? 'btn-primary' : 'btn-outline-primary'}" %>
        <%= link_to "Monthly View", admin_dashboard_path(view: 'monthly'), class: "btn #{@view_type == 'monthly' ? 'btn-primary' : 'btn-outline-primary'}" %>
      </div>
    </div>
  </div>

  <!-- Date Range Selector -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Select Date Range</h5>
          <%= form_tag admin_dashboard_path, method: :get, class: 'd-flex gap-3 align-items-end' do %>
            <%= hidden_field_tag :view, @view_type %>

            <div>
              <%= label_tag :start_date, "Start Date", class: "form-label" %>
              <%= date_field_tag :start_date, @start_date, class: "form-control" %>
            </div>

            <div>
              <%= label_tag :end_date, "End Date", class: "form-label" %>
              <%= date_field_tag :end_date, @end_date, class: "form-control" %>
            </div>

            <%= submit_tag "Apply", class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body text-center">
          <h5 class="card-title">Total Database Queries</h5>
          <h2 class="mb-0 fw-bold">
            <%= number_with_delimiter(@total_queries) %>
          </h2>
          <p class="text-muted">Total for <%= @date_range %></p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body text-center">
          <h5 class="card-title">Unique Users</h5>
          <h2 class="mb-0 fw-bold">
            <%= number_with_delimiter(@total_users) %>
          </h2>
          <p class="text-muted">Peak daily users for <%= @date_range %></p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body text-center">
          <h5 class="card-title">Avg Query Duration</h5>
          <h2 class="mb-0 fw-bold">
            <%= number_with_precision(@avg_duration, precision: 2) %> ms
          </h2>
          <p class="text-muted">Average for <%= @date_range %></p>
        </div>
      </div>
    </div>
  </div>

  <% if @usage_data && @usage_data['metrics'].present? %>
    <!-- Database Query Volume Chart -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Database Query Volume</h5>
            <canvas id="queryVolumeChart" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Query Duration Chart -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Average Query Duration (ms)</h5>
            <canvas id="queryDurationChart" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Users and Queries Per User Chart -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Daily Users & Queries Per User</h5>
            <canvas id="usersChart" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Metrics Table -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Detailed Daily Metrics</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Total Queries</th>
                    <th>Avg Duration (ms)</th>
                    <th>Unique Users</th>
                    <th>Queries Per User</th>
                  </tr>
                </thead>
                <tbody>
                  <% @usage_data['metrics'].each do |day| %>
                    <tr>
                      <td><%= Date.parse(day['date']).strftime('%b %d, %Y') %></td>
                      <td><%= number_with_delimiter(day['total_queries']) %></td>
                      <td><%= number_with_precision(day['avg_query_duration_ms'], precision: 2) %></td>
                      <td><%= day['unique_users'] %></td>
                      <td><%= number_with_precision(day['queries_per_user'], precision: 2) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="row">
      <div class="col-12">
        <div class="alert alert-info">
          No usage data available for the selected date range. Please try different dates or check if the API is accessible.
        </div>
      </div>
    </div>
  <% end %>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    <% if @usage_data && @usage_data['metrics'].present? %>
      // Common chart options
      const chartOptions = {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += new Intl.NumberFormat().format(context.parsed.y);
                }
                return label;
              }
            }
          }
        }
      };

      // Prepare data
      const dates = <%= raw @usage_data['metrics'].map { |d| Date.parse(d['date']).strftime('%b %d') }.to_json %>;
      const totalQueries = <%= raw @usage_data['metrics'].map { |d| d['total_queries'] }.to_json %>;
      const avgDurations = <%= raw @usage_data['metrics'].map { |d| d['avg_query_duration_ms'] }.to_json %>;
      const uniqueUsers = <%= raw @usage_data['metrics'].map { |d| d['unique_users'] }.to_json %>;
      const queriesPerUser = <%= raw @usage_data['metrics'].map { |d| d['queries_per_user'] }.to_json %>;

      // Query Volume Chart
      new Chart(document.getElementById('queryVolumeChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [{
            label: 'Total Queries',
            data: totalQueries,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          ...chartOptions,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Query Count'
              }
            }
          }
        }
      });

      // Query Duration Chart
      new Chart(document.getElementById('queryDurationChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Average Query Duration (ms)',
            data: avgDurations,
            backgroundColor: 'rgba(255, 159, 64, 0.2)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 2,
            tension: 0.1
          }]
        },
        options: {
          ...chartOptions,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Duration (ms)'
              }
            }
          }
        }
      });

      // Users and Queries Per User Chart
      new Chart(document.getElementById('usersChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: dates,
          datasets: [
            {
              label: 'Unique Users',
              data: uniqueUsers,
              backgroundColor: 'rgba(75, 192, 192, 0.5)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Queries Per User',
              data: queriesPerUser,
              backgroundColor: 'rgba(153, 102, 255, 0.5)',
              borderColor: 'rgba(153, 102, 255, 1)',
              borderWidth: 1,
              type: 'line',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          ...chartOptions,
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'User Count'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Queries Per User'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    <% end %>
  });
</script>